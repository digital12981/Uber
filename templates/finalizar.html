{% extends "layout.html" %}

{% block title %}Pagamento do Adesivo Uber{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- Header -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <div class="flex items-center mb-4">
            <img src="https://i.ibb.co/wFFn5HSn/13093103960002-1.png" alt="Uber" class="h-16 mr-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Pagamento do Adesivo</h1>
                <p class="text-gray-600">Programa Uber - R$ 500,00 Mensais</p>
            </div>
        </div>
        
        <div class="bg-black text-white p-4" style="border-radius: 0px !important;">
            <p class="text-sm text-white">
                <strong>Adesivo Obrigatório:</strong> Para receber os R$ 500,00 mensais é necessário pagar pelo adesivo Uber personalizado.
            </p>
        </div>
    </div>

    <!-- Adesivo Information -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Informações do Adesivo</h2>
        
        <div class="space-y-3">
            <p>Programa: <strong>Uber Partner</strong></p>
            <p>Benefício Mensal: <strong>R$ 500,00</strong></p>
            <p>Adesivo Personalizado com entrega via Sedex</p>
            <p>Instalação obrigatória no veículo</p>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Resumo do Pagamento</h2>
        
        <div class="space-y-3">
            <div class="flex justify-between items-center border-b pb-2">
                <span class="text-gray-600">Adesivo Uber:</span>
                <span class="font-medium">R$ 82,10</span>
            </div>
            <div class="flex justify-between items-center border-b pb-2">
                <span class="text-gray-600">Entrega Sedex:</span>
                <span class="font-medium">Incluído</span>
            </div>
            <div class="flex justify-between items-center text-lg font-bold text-black bg-gray-100 p-3" style="border-radius: 0px !important;">
                <span>Total a Pagar:</span>
                <span>R$ 82,10</span>
            </div>
        </div>
    </div>

    <!-- Warning -->
    <div class="bg-yellow-50 p-4 mb-6" style="border-radius: 0px !important;">
        <p class="text-sm text-yellow-700">
            <strong>Importante:</strong> O adesivo será enviado apenas após confirmação do pagamento via PIX. 
            O envio será feito em até 24 horas úteis via Sedex para o endereço cadastrado.
        </p>
    </div>

    <!-- Payment Section -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Pagamento do Adesivo</h2>
        
        <div class="text-center">
            <!-- PIX Information Display -->
            <div id="pixInfo">
                <!-- QR Code -->
                <div class="mb-4">
                    <img id="pixQrCode" src="" alt="QR Code PIX" class="mx-auto w-64 h-64 border-2 border-gray-300" style="border-radius: 0px !important; display: none;">
                </div>
                
                <!-- PIX Code -->
                <div class="mb-4" id="pixCodeSection" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código PIX:</label>
                    <div class="flex">
                        <input type="text" id="pixCode" readonly class="flex-1 px-3 py-2 border border-gray-300 text-sm" style="border-radius: 0px !important;">
                        <button onclick="copyPixCode()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 text-sm" style="border-radius: 0px !important;">
                            Copiar
                        </button>
                    </div>
                </div>
                
                <div id="loadingMessage" class="text-gray-600 mb-4">
                    Carregando dados de pagamento...
                </div>
            </div>
            
            <p class="text-sm text-gray-600">
                Pagamento seguro processado via For4Payments
            </p>
        </div>
    </div>
</div>

<script>
// Auto-generate PIX payment on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Get user data from localStorage (same format as original)
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const paymentData = JSON.parse(localStorage.getItem('cnvPaymentData') || '{}');
        
        const userName = paymentData.name || userData.full_name || userData.name || localStorage.getItem('candidateName') || '';
        const userCPF = paymentData.cpf || userData.cpf || localStorage.getItem('candidateCPF') || '';
        const userPhone = paymentData.phone || userData.phone || localStorage.getItem('candidatePhone') || '';
        const userEmail = paymentData.email || userData.email || localStorage.getItem('candidateEmail') || '';
        
        console.log('Extracted user data:', { name: userName, cpf: userCPF, phone: userPhone });
        
        if (userName && userCPF) {
            // Create payment using existing endpoint
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: userName,
                    cpf: userCPF,
                    email: userEmail,
                    phone: userPhone
                })
            });
            
            const result = await response.json();
            console.log('API Response:', result);
            
            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                console.log('PIX Data:', pixData);
                
                // Display real PIX code
                if (pixData.pixCopyPaste) {
                    document.getElementById('pixCode').value = pixData.pixCopyPaste;
                    document.getElementById('pixCodeSection').style.display = 'block';
                    console.log('PIX code set successfully');
                }
                
                // Display real QR Code
                if (pixData.pixQrCode) {
                    const qrCodeElement = document.getElementById('pixQrCode');
                    qrCodeElement.src = pixData.pixQrCode;
                    qrCodeElement.style.display = 'block';
                    console.log('QR Code displayed successfully');
                }
                
                // Store payment ID for status checking
                if (pixData.paymentId) {
                    localStorage.setItem('cnvPaymentId', pixData.paymentId);
                    console.log('Payment ID stored:', pixData.paymentId);
                }
                
                // Hide loading message
                document.getElementById('loadingMessage').style.display = 'none';
                
            } else {
                throw new Error(result.error || 'Erro ao criar pagamento PIX');
            }
        } else {
            console.error('Dados do usuário incompletos:', { name: userName, cpf: userCPF, phone: userPhone });
            document.getElementById('loadingMessage').textContent = 'Erro: Dados do usuário não encontrados.';
        }
    } catch (error) {
        console.error('Erro ao criar pagamento:', error);
        document.getElementById('loadingMessage').textContent = 'Erro ao carregar dados de pagamento.';
    }
});

// Copy PIX code function
function copyPixCode() {
    const pixCodeInput = document.getElementById('pixCode');
    pixCodeInput.select();
    pixCodeInput.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        
        const button = event.target.closest('button');
        const originalText = button.textContent;
        button.textContent = 'Copiado!';
        button.classList.add('bg-green-600');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600');
        }, 2000);
        
    } catch (err) {
        alert('Erro ao copiar código PIX');
    }
}
</script>
{% endblock %}