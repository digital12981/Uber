{% extends "layout.html" %}

{% block content %}
<div style="min-height: 100vh; background-color: white; padding: 32px 16px;">
    <div style="max-width: 1024px; margin: 0 auto;">
        
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 48px;">
            <h1 style="font-size: 28px; font-weight: 700; color: #333333; margin-bottom: 16px;">Taxa de Instalação do Adesivo Uber</h1>
            <p style="font-size: 16px; color: #dc2626; font-weight: 600;">PAGAMENTO OBRIGATÓRIO</p>
        </div>

        <!-- Important Information -->
        <div style="margin-bottom: 48px;">
            <h2 style="font-size: 28px; font-weight: 700; color: #333333; margin-bottom: 24px;">⚠️ Informações Importantes sobre a Instalação</h2>
            <div style="font-size: 16px; color: #333333;">
                <p style="margin-bottom: 12px;">• <strong>O adesivo DEVE ser instalado por um funcionário autorizado da Uber</strong></p>
                <p style="margin-bottom: 12px;">• O funcionário irá instalar o adesivo e tirar foto como comprovação</p>
                <p style="margin-bottom: 12px;">• <strong>Sem o pagamento desta taxa, você NÃO participará do programa</strong></p>
                <p style="margin-bottom: 12px;">• <strong>Sem a instalação, você NÃO receberá os R$ 500,00 mensais por 3 anos</strong></p>
            </div>
        </div>

        <!-- Calendar Section -->
        <div style="margin-bottom: 48px;">
            <h2 style="font-size: 28px; font-weight: 700; color: #333333; margin-bottom: 24px;">Agendar Instalação do Adesivo</h2>
            
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #333333; margin-bottom: 16px;">Selecione o Dia:</h3>
                <div style="background-color: #EEEEEE; padding: 24px; border-radius: 0px;">
                    <div id="calendar-container" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;">
                        <!-- Calendar will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #333333; margin-bottom: 16px;">Selecione o Horário:</h3>
                <div style="background-color: #EEEEEE; padding: 24px; border-radius: 0px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <button class="time-btn" data-time="07:00 - 09:00" style="padding: 12px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">07:00 - 09:00</button>
                        <button class="time-btn" data-time="09:00 - 11:00" style="padding: 12px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">09:00 - 11:00</button>
                        <button class="time-btn" data-time="11:00 - 13:00" style="padding: 12px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">11:00 - 13:00</button>
                        <button class="time-btn" data-time="13:00 - 15:00" style="padding: 12px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">13:00 - 15:00</button>
                        <button class="time-btn" data-time="15:00 - 17:00" style="padding: 12px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">15:00 - 17:00</button>
                    </div>
                </div>
            </div>

            <!-- Selected Appointment -->
            <div id="appointment-display" style="display: none; margin-bottom: 32px;">
                <h4 style="font-size: 16px; font-weight: 600; color: #059669; margin-bottom: 8px;">Agendamento Selecionado:</h4>
                <p style="font-size: 16px; color: #333;">
                    Data: <span id="selected-date"></span><br>
                    Horário: <span id="selected-time"></span>
                </p>
            </div>
        </div>

        <!-- PIX Section -->
        <div>
            <div style="text-align: center; margin-bottom: 32px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #333333; margin-bottom: 8px;">PIX - R$ 82,10</h2>
                <p style="font-size: 16px; color: #666;">Taxa de Instalação do Adesivo</p>
            </div>

            <div id="loading-pix" style="text-align: center; font-size: 16px; color: #666; margin-bottom: 32px;">
                Carregando dados de pagamento...
            </div>

            <div style="text-align: center; margin-bottom: 32px;">
                <img id="qr-code-img" src="" alt="QR Code PIX" style="display: none; width: 192px; height: 192px; border: 1px solid #ddd;">
            </div>

            <div id="pix-code-section" style="display: none; margin-bottom: 32px;">
                <label style="font-size: 16px; font-weight: 500; color: #333; margin-bottom: 8px; display: block;">Código PIX (Copia e Cola)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="pix-code-input" readonly style="flex: 1; padding: 8px 12px; border: 1px solid #ccc; font-family: monospace; background: #f9f9f9;">
                    <button onclick="copyCode()" id="copy-btn" style="padding: 8px 16px; background: #333; color: white; border: none; cursor: pointer;">Copiar</button>
                </div>
            </div>

            <div>
                <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">Como pagar:</h3>
                <ol style="font-size: 16px; color: #666; padding-left: 20px;">
                    <li style="margin-bottom: 8px;">Selecione data e horário para instalação acima</li>
                    <li style="margin-bottom: 8px;">Abra o app do seu banco</li>
                    <li style="margin-bottom: 8px;">Escolha a opção PIX</li>
                    <li style="margin-bottom: 8px;">Escaneie o QR Code ou cole o código</li>
                    <li style="margin-bottom: 8px;">Confirme o pagamento de R$ 82,10</li>
                    <li style="margin-bottom: 8px;">Aguarde nosso funcionário no dia e horário agendados</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
let selectedDate = null;
let selectedTime = null;

// Generate calendar
function generateCalendar() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const today = now.getDate();
    
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDay = firstDay.getDay();
    
    const container = document.getElementById('calendar-container');
    container.innerHTML = '';
    
    // Month header
    const monthHeader = document.createElement('div');
    monthHeader.style.cssText = 'grid-column: 1 / -1; font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px; text-align: center;';
    monthHeader.textContent = `${monthNames[month]} ${year}`;
    container.appendChild(monthHeader);
    
    // Day headers
    dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.style.cssText = 'font-size: 12px; font-weight: 500; color: #666; padding: 8px 0; text-align: center;';
        dayHeader.textContent = day;
        container.appendChild(dayHeader);
    });
    
    // Empty days
    for (let i = 0; i < startDay; i++) {
        container.appendChild(document.createElement('div'));
    }
    
    // Calendar days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayBtn = document.createElement('button');
        dayBtn.textContent = day;
        dayBtn.className = 'day-btn';
        
        const baseStyle = 'width: 40px; height: 40px; border: 2px solid #333; background: white; color: #333; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;';
        
        if (day <= today + 3) {
            dayBtn.style.cssText = baseStyle + 'background: #f3f4f6; color: #9ca3af; border-color: #d1d5db; cursor: not-allowed; box-shadow: none;';
            dayBtn.disabled = true;
        } else {
            dayBtn.style.cssText = baseStyle;
            dayBtn.onclick = () => selectDate(day, month, year, dayBtn);
        }
        
        container.appendChild(dayBtn);
    }
}

// Select date
function selectDate(day, month, year, element) {
    selectedDate = `${day}/${month + 1}/${year}`;
    
    document.querySelectorAll('.day-btn:not([disabled])').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#333';
    });
    
    element.style.background = '#333';
    element.style.color = 'white';
    
    updateAppointment();
}

// Setup time selector
function setupTimeSelector() {
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.onclick = function() {
            selectedTime = this.dataset.time;
            
            document.querySelectorAll('.time-btn').forEach(b => {
                b.style.background = 'white';
                b.style.color = '#333';
            });
            
            this.style.background = '#333';
            this.style.color = 'white';
            
            updateAppointment();
        };
        
        btn.onmouseover = function() {
            if (this.style.background !== 'rgb(51, 51, 51)') {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
            }
        };
        
        btn.onmouseout = function() {
            if (this.style.background !== 'rgb(51, 51, 51)') {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            }
        };
    });
}

// Update appointment display
function updateAppointment() {
    if (selectedDate && selectedTime) {
        document.getElementById('selected-date').textContent = selectedDate;
        document.getElementById('selected-time').textContent = selectedTime;
        document.getElementById('appointment-display').style.display = 'block';
        
        localStorage.setItem('selectedAppointment', JSON.stringify({
            date: selectedDate,
            time: selectedTime
        }));
    }
}

// Copy PIX code
function copyCode() {
    const input = document.getElementById('pix-code-input');
    input.select();
    document.execCommand('copy');
    
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copiado!';
    btn.style.background = '#059669';
}

// Load PIX payment
async function loadPixPayment() {
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        
        const userName = userData.full_name || localStorage.getItem('candidateName') || '';
        const userCPF = userData.cpf || localStorage.getItem('candidateCPF') || '';
        const userPhone = userData.phone || localStorage.getItem('candidatePhone') || '';
        const userEmail = userData.email || localStorage.getItem('candidateEmail') || '';
        
        if (userName && userCPF) {
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: userName,
                    cpf: userCPF,
                    email: userEmail,
                    phone: userPhone
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                
                if (pixData.pixCopyPaste) {
                    document.getElementById('pix-code-input').value = pixData.pixCopyPaste;
                    document.getElementById('pix-code-section').style.display = 'block';
                }
                
                if (pixData.pixQrCode) {
                    document.getElementById('qr-code-img').src = pixData.pixQrCode;
                    document.getElementById('qr-code-img').style.display = 'block';
                }
                
                document.getElementById('loading-pix').style.display = 'none';
            }
        }
    } catch (error) {
        document.getElementById('loading-pix').textContent = 'Erro ao carregar pagamento';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    generateCalendar();
    setupTimeSelector();
    loadPixPayment();
});
</script>

{% endblock %}